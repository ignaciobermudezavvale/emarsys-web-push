<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>EmarsysWebPush</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script type="text/javascript" src="https://client-version.cf.emarsys.net/web-emarsys-sdk-v4/latest/web-emarsys-sdk.js" async></script>

  <script type="text/javascript">
    var ScarabQueue = ScarabQueue || [];
    (function(id) {
      if (document.getElementById(id)) return;
      var js = document.createElement('script'); js.id = id;
      js.src = '//cdn.scarabresearch.com/js/1C6A9FE107F1D289/scarab-v2.js';
      var fs = document.getElementsByTagName('script')[0];
      fs.parentNode.insertBefore(js, fs);
    })('scarab-js-api');
  </script>

  <script>
    ScarabQueue.push(['login', 'tommy.oliver@method.com.ar']);

    ScarabQueue.push(['cart', [
      {item: '000011020180190140cannonSite', price: 75, quantity: 1},
    ]]);
    ScarabQueue.push(['go']);

  </script>

  <script>
  // Activar modo debug
  localStorage.setItem('emarsys:debug', 'true');

  // Asegurar la cola global
  window.WebEmarsysSdk = window.WebEmarsysSdk || [];

  // Esperar a que cargue el SDK
  window.addEventListener('load', () => {
    WebEmarsysSdk.push(['init', {
      applicationCode: 'EMSDE-283A2',
      enableMacSafariVapid: false,
      defaultNotificationTitle: 'Web push Piero',
      defaultNotificationIcon: 'https://yoursite.com/img/your-logo.png',
      autoSubscribe: false,
      serviceWorker: {
        url: 'web-emarsys-service-worker.js',
        applicationServerPublicKey: 'BIHgJ07cJBGpQplKGGd-CdJWgNYwBqvWNg65fiPXpIUn9fZuNZ121tUMdmwpBkzPYtu9i17JmFD_eboYiS3KcSU'
      }
    }]);

    // Cuando el SDK est√© listo
    WebEmarsysSdk.push(['ready', () => {
      console.log('üü¢ SDK Emarsys listo');
      console.log('üî∏ Permiso actual:', Notification.permission);

      WebEmarsysSdk.push(['isSubscribed', (status) => {
        console.log('¬øEst√° suscrito?:', status);
        if (!status) {
          console.log('üì¢ Suscribiendo usuario...');
          WebEmarsysSdk.push(['subscribe', (s) => console.log('üÜï Nueva suscripci√≥n:', s)]);
        } else {
          WebEmarsysSdk.push(['getSubscription', (s) => console.log('üì¨ Subscription existente:', s)]);
        }
      }]);

      // Vincular contacto
      WebEmarsysSdk.push(['setContact', { contactFieldId: 3, contactFieldValue: 'tommy.oliver@method.com.ar' }]);
    }]);

    WebEmarsysSdk.push(['onError', (e) => console.error('‚ùå Error SDK Emarsys:', e)]);
    WebEmarsysSdk.push(['onSubscribe', () => console.log('‚úÖ Usuario suscripto a Web Push')]);
  });
</script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const permission = await Notification.requestPermission();
        console.log('üü¢ Permiso de notificaciones:', permission);
        if (permission === 'granted') {
          WebEmarsysSdk.push(['subscribe']);
        } else {
          console.warn('‚ö†Ô∏è El usuario no otorg√≥ permisos de notificaci√≥n.');
        }
      } catch (err) {
        console.error('‚ùå Error al pedir permiso de notificaciones:', err);
      }
    });
  </script>
  <script>
    function generalSubscribe() {
            return WebEmarsysSdk.subscribe()
    }
    // The submit event fires when a <form> is submitted.
    document.addEventListener('submit', function(e) {
            generalSubscribe();
    });
    // An element receives a click event when a pointing device button (such as a mouse's primary mouse button) is both pressed and released while the pointer is located inside the element.
    document.addEventListener('click', function(e) {
            generalSubscribe();
    });
  </script>
</head>
<body>
  <button onclick="generalSubscribe()">Subscribe</button>
  <app-root></app-root>
</body>
</html>
