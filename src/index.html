<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Emarsys Web Push</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Emarsys Web SDK -->
  <script
    src="https://client-version.cf.emarsys.net/web-emarsys-sdk-v4/latest/web-emarsys-sdk.js"
    async>
  </script>

  <!-- Emarsys Predict (opcional) -->
  <script type="text/javascript">
    var ScarabQueue = ScarabQueue || [];
    (function(id) {
      if (document.getElementById(id)) return;
      var js = document.createElement('script'); js.id = id;
      js.src = '//cdn.scarabresearch.com/js/1C6A9FE107F1D289/scarab-v2.js';
      var fs = document.getElementsByTagName('script')[0];
      fs.parentNode.insertBefore(js, fs);
    })('scarab-js-api');
  </script>

  <script>
    /* ==========================
       DEBUG (solo dev)
    ========================== */
    localStorage.setItem('emarsys:debug', 'true');

    /* ==========================
       Cola global SDK
    ========================== */
    window.WebEmarsysSdk = window.WebEmarsysSdk || [];

    /* ==========================
       INIT SDK
    ========================== */
    WebEmarsysSdk.push(['init', {
      applicationCode: 'EMSDE-283A2',
      enableMacSafariVapid: false,
      defaultNotificationTitle: 'Web push Piero',
      defaultNotificationIcon: 'https://yoursite.com/img/your-logo.png',
      autoSubscribe: false,
      serviceWorker: {
        url: 'web-emarsys-service-worker.js',
        applicationServerPublicKey: 'BIHgJ07cJBGpQplKGGd-CdJWgNYwBqvWNg65fiPXpIUn9fZuNZ121tUMdmwpBkzPYtu9i17JmFD_eboYiS3KcSU'
      }
    }]);

    /* ==========================
       READY
    ========================== */
    WebEmarsysSdk.push(['ready', () => {
      console.log('ðŸŸ¢ Emarsys SDK listo');
      console.log('ðŸ”” Permiso:', Notification.permission);
    }]);

    /* ==========================
       ERROR HANDLER
    ========================== */
    WebEmarsysSdk.push(['onError', (e) => {
      console.error('âŒ Emarsys error:', e);
    }]);

    /* ==========================
       SUBSCRIBE FLOW
    ========================== */
    function autoSubscribe() {
    WebEmarsysSdk.push(['isSubscribed', (subscribed) => {
      if (subscribed) return;

      WebEmarsysSdk.push(['setContact', {
        contactFieldId: 3,
        contactFieldValue: 'tommy.oliver@method.com.ar'
      }]);

      WebEmarsysSdk.push(['subscribe']);
    }]);
  }

  WebEmarsysSdk.push(['ready', () => {

    // Caso 1: permiso ya otorgado â†’ automÃ¡tico
    if (Notification.permission === 'granted') {
      autoSubscribe();
      return;
    }

    // Caso 2: permiso no definido â†’ esperar acciÃ³n del usuario
    console.log('ðŸ”” Mostrar soft prompt de notificaciones');
  }]);
  </script>
</head>

<body>
  <!-- AcciÃ³n explÃ­cita del usuario -->
  <button onclick="
    Notification.requestPermission().then(p => {
      if (p === 'granted') autoSubscribe();
    })
  ">
    Activar notificaciones
  </button>

  <app-root></app-root>
</body>
</html>
